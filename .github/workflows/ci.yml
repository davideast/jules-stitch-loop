name: ðŸ›¡ï¸ Loop Integrity Check
on: [pull_request]
jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: oven-sh/setup-bun@v1
      - run: bun install

      # 1. Baton Check
      - name: Verify Baton
        id: check_baton
        continue-on-error: true
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "next-prompt.md"; then
            echo "âœ… Baton passed."
          else
            MSG="CRITICAL: You MUST update 'next-prompt.md'."
            echo "log=$(echo "$MSG" | base64 -w 0)" >> $GITHUB_OUTPUT
            exit 1
          fi

      # 2. Attribution Check
      - name: Verify Attribution
        id: check_attr
        continue-on-error: true
        run: |
          bun run scripts/verify-attribution.ts || {
             MSG="MISSING ATTRIBUTION: Commit message needs 'Co-authored-by'."
             echo "log=$(echo "$MSG" | base64 -w 0)" >> $GITHUB_OUTPUT
             exit 1
          }

      # 3. Report to Jules
      - name: Report Failures
        if: always() && (steps.check_baton.outcome == 'failure' || steps.check_attr.outcome == 'failure')
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          BRANCH_NAME: ${{ github.head_ref }}
          BATON_LOG_B64: ${{ steps.check_baton.outputs.log }}
          ATTR_LOG_B64: ${{ steps.check_attr.outputs.log }}
        run: bun run scripts/ci-report.ts

      - name: Fail Job
        if: always()
        run: |
          if [ "${{ steps.check_baton.outcome }}" == "failure" ] || [ "${{ steps.check_attr.outcome }}" == "failure" ]; then exit 1; fi